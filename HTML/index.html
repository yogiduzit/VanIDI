<!DOCTYPE html>
<html>

<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <!-- Boostrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <!-- Animate.css -->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.css">
  <!-- Custom -->
  <link rel="stylesheet" href="stylesheets/stylesheet.css">
</head>

<body>
 



  <div id="container-header" class="container-fluid text-center animated fadeIn">
    <!-- Branding/ Login Row -->
    <div class="header-row row py-2 align-middle">
      <h1 class="col-2 text-left">Logo</h1>
      <div class="col-3 text-right ml-auto">
        <button type="button" class="btn btn-primary">Login</button>
      </div>
    </div>
    <!-- Input Row -->
    <div id="header-row-2" class="header-row row">
      <div class="col-2">
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <label class="btn btn-primary active">
            <input type="radio" name="options" id="option1" autocomplete="off" checked> Street Mode
          </label>
          <label class="btn btn-primary">
            <input type="radio" name="options" id="option2" autocomplete="off"> Intersection Mode
          </label>
        </div>
      </div>
      <!-- Intersection Input Form -->
      <div class="col-5 text-left mr-auto">
        <div class="input-group align-middle">
          <span class="mx-2 align-middle">Intersection of</span>
          <input type="text" class="form-control" name="intersection-street1">
          <span class="mx-2 align-middle">and</span>
          <input type="text" class="form-control" name="intersection-street2">
          <span class="mx-2 align-middle">km Radius: </span>
          <input type="number" class="form-control" name="intersection-radius" min="0">
          <div class="input-group-append">
            <button class="btn btn-primary text-white" type="button">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Filter SidePane -->
    <div id="filter-map-row" class="row animated fadeIn">
      <div id="row-map" class="col-10 p-0">
        <div id="map" onmousedown="isCtrlDown(event)"></div>
      </div>
      <div id="filter-panel" class="col-2 ml-auto text-left pt-3">
        <h4 class="mb-3">Filters and Export</h4>        
        <div class="accordion" id="accordionExample">
          <div class="card">
            <div class="card-header" id="headingOne">
              <h2 class="mb-0">
                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  Datasets
                </button>
              </h2>
            </div>
            <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
              <div class="card-body">
                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingTwo">
              <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  Filters
                </button>
              </h2>
            </div>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
              <div class="card-body">
                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  Export Options
                </button>
              </h2>
            </div>
            <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
              <div class="card-body">
                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
              </div>
            </div>
          </div>
        </div>
        <div class="input-group">
          <input type="text" class="form-control" aria-label="Text input with dropdown button" placeholder="Enter filename">
          <div class="input-group-append">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">.csv</button>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="#">.csv</a>
              <a class="dropdown-item" href="#">.xlsx</a>
              <a class="dropdown-item" href="#">.shp</a>
            </div>
          </div>
        </div>
        <div class="text-right mt-3">
          <button class="btn btn-primary" type="submit">Export</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Load jQuery -->
  <script src="js/jquery-3.4.1.js"></script>
  <!-- Bootstrap js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <!-- Requests -->
  <script src="data/requests.js" type="module"></script>
  <!-- JSONUTils -->
  <script type="text/javascript" src="js/JSONUTils.js"></script>
  <!-- JS for Map -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3JV6v8W19iItY1AvkMOtjaMSgidnp-vQ&callback=initMap"
  async defer></script>
  <script src="js/map.js"></script>
  <!-- Cropper JS -->
  <script src="js/cropper.js"></script>
  <!-- Main custom -->
  <script type="text/javascript" src="js/main.js"></script>
</body>
</html>


<script>
connectBikeData();
async function connectBikeData(){

    let bikeCounts = await getAverageBikeData();
    let countsLocations = await getBikeLocations();

    console.log(bikeCounts);
    console.log(countsLocations);

      for(c in bikeCounts){
        bikeCounts[c].lat = countsLocations[c].lat;
        bikeCounts[c].lng = countsLocations[c].lng;
        bikeCounts[c].dir = countsLocations[c].dir;

      }
}

async function getAverageBikeData(){

  //Retrieving bike counts information 
  let resCounts = await fetch('https://decode-congestion-vancouver.opendatasoft.com/api/records/1.0/search/?dataset=bike-data-2015jan-2019jul&apikey=303b3ded3bc5bc79e593dd1d6605d4f2a7b2b6261354474526cc8309', (res) => {
    return res;
  });


  let countsJSON = await resCounts.json().then((data) =>{
    let countObjects = {};
    data.records.forEach(element => {
      for(e in element.fields){
        if(e == "date") continue;
        if(countObjects[e]){
          countObjects[e].total += typeof(element.fields[e]) == "string" ? parseInt(element.fields[e]):(element.fields[e]);
          countObjects[e].count++;

        }else{
          countObjects[e] = {};
          countObjects[e].total = typeof(element.fields[e]) == "string" ? parseInt(element.fields[e]):(element.fields[e]);
          countObjects[e].count = 1;
        }
      }
    });

    for(c in countObjects){
      countObjects[c].average = countObjects[c].total/countObjects[c].count;
    }
    return countObjects;
  });

  return countsJSON;
  
}

async function getBikeLocations(){

    //Retrieving bike location information 
    let resLocations = await fetch('https://decode-congestion-vancouver.opendatasoft.com/api/records/1.0/search/?dataset=bike-volume-counter-locations&rows=1000&apikey=303b3ded3bc5bc79e593dd1d6605d4f2a7b2b6261354474526cc8309', (res) => {
      return res;
    });

    let locationObjects = {};
    let locationData = await resLocations.json().then((data) =>{
      data.records.forEach(element => {

        //Edit the text names
        let text = element.fields["counters"];
        
        text = text.replace('_', ' ').replace('&', '').replace(/\s{2,}/g,' ').split(' ').filter(word => word !== '-').map(word => word.toLowerCase()).join('_');

        //Add our data to the location objects
        locationObjects[text] = {};
        locationObjects[text].lat = element.fields["latitude"];
        locationObjects[text].lng = element.fields["longitude"];

        switch(true){
          case text.includes('westb'):
            locationObjects[text].dir = 'west';
            break;
          case text.includes('eastb'):
            locationObjects[text].dir = 'east';
            break;
          case text.includes('northb'):
            locationObjects[text].dir = 'north';
            break;
          default:
            locationObjects[text].dir = 'south';
        }

      });    
    });


    return locationObjects;
}



// distance is in metres (1000 is a km)
// dir is the direction (west,east,north,south)
// long is east (increases) or west (decreases more)
// lat is north (increases) or south (decreases)
function getOffsetLocation(lat, long, dir, distance){

  let res = {};
  const EARTH = 6378.137;
  const M = (1 / ((Math.PI / 180) * EARTH)) / 1000;  //1 meter in degree
  cos = Math.cos;
  let newLat = lat;
  let newLong = long;

  switch(dir){
    case 'west':
      newLong += (distance*M)/(cos(newLat * (Math.PI / 180)));
      break;
    case 'east':
      newLong -= (distance*M)/cos(newLat * (Math.PI / 180));
      break;
    case 'north':
      newLat += distance*M;
      break;
    default:
      newLat -= distance*M;
  }

  res.lat = newLat;
  res.lng = newLong;
  return res;
}

// returns the distance from one point on a map to another. 
function getDistanceFrom(coord1,coord2) {

  let R = 6371; // Radius of the earth in km
  let dLat = deg2rad(coord2.lat-coord1.lat);  // deg2rad below
  let dLon = deg2rad(coord2.lng-coord1.lng); 
  let a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
          Math.cos(deg2rad(coord1.lat)) * Math.cos(deg2rad(coord2.lat)) * 
          Math.sin(dLon/2) * Math.sin(dLon/2); 

  let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  let d = R * c; // Distance in km
  return d;
}

function deg2rad(deg) {
  return deg * (Math.PI/180); 
}
</script>
